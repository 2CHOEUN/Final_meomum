<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.mm.turnback">
	<insert id="returnApplyInsert" parameterType="com.mm.turnback.model.ReturnDTO">
		insert into turnback
		values(
			return_idx.nextval,
			#{order_idx},
			#{user_idx},
			#{pro_idx},
			sysdate,
			NULL,
			NULL,
			#{return_reason}
		)
	</insert>

	<select id="returnProList" parameterType="Map" resultType="com.mm.turnback.model.ReturnListDTO">
		select * from
		(select rownum as rnum, a.*from(
			SELECT *FROM orders o
			JOIN order_pro op ON o.order_idx = op.order_idx
			JOIN product p ON op.pro_idx = p.pro_idx
			JOIN turnback t ON o.order_idx = t.order_idx
			WHERE o.order_idx=op.order_idx
			    and o.order_idx=t.order_idx
			    and op.pro_idx=p.pro_idx
			order by order_date desc
		)a )b
		where rnum<![CDATA[>=]]>#{start} and rnum<![CDATA[<=]]>#{end}
	</select>
	
	<select id="returnProListCnt" resultType="Integer">
		select count(*) from
			orders o
			JOIN order_pro op ON o.order_idx = op.order_idx
			JOIN product p ON op.pro_idx = p.pro_idx
			JOIN turnback t ON o.order_idx = t.order_idx
			WHERE o.order_idx=op.order_idx
			    and o.order_idx=t.order_idx
			    and op.pro_idx=p.pro_idx
	</select>
	
	<select id="returnData" parameterType="String" resultType="com.mm.turnback.model.ReturnListDTO">
			SELECT *FROM orders o
			JOIN order_pro op ON o.order_idx = op.order_idx
			JOIN product p ON op.pro_idx = p.pro_idx
			JOIN turnback t ON o.order_idx = t.order_idx
			WHERE o.order_idx=op.order_idx
			    and o.order_idx=t.order_idx
			    and op.pro_idx=p.pro_idx
				and order_idx=#{order_idx}
	</select>
</mapper>